
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Bot Factory</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* Cyber Factory Theme */
    body {
        margin: 0; padding: 0;
        background: #0b0c15;
        color: #e2e8f0;
        font-family: 'Inter', system-ui, sans-serif;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Background Grid */
    .bg-grid {
        position: fixed; inset: 0; z-index: -1;
        background-image: 
            linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
    }

    /* Header */
    .header {
        height: 60px;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 24px;
        z-index: 10;
    }
    .header h1 {
        font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
        background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin: 0;
    }
    
    /* Main Content */
    .factory-layout {
        flex: 1;
        display: flex;
        overflow: hidden;
    }
    
    /* Left: Raw Cores (Files) */
    .panel-left {
        width: 300px;
        background: rgba(10, 10, 15, 0.6);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        display: flex; flex-direction: column;
    }
    
    .panel-header {
        padding: 20px;
        font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        color: #6366f1;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex; justify-content: space-between; align-items: center;
    }
    
    .file-list {
        flex: 1; overflow-y: auto; padding: 12px;
    }
    
    .file-item {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 10px;
    }
    .file-item:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: #6366f1;
        transform: translateX(4px);
    }
    .file-icon { font-size: 16px; opacity: 0.7; }
    .file-name { font-size: 13px; font-weight: 500; word-break: break-all; }
    
    /* Right: Active Bots */
    .panel-right {
        width: 400px;
        background: rgba(10, 10, 15, 0.6);
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        display: flex; flex-direction: column;
    }
    
    .bot-list {
        flex: 1; overflow-y: auto; padding: 0; /* Padding inside items/headers */
    }
    
    /* Group Headers */
    .group-header {
        position: sticky; top: 0;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        padding: 10px 20px;
        font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
        color: #94a3b8;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        border-top: 1px solid rgba(255,255,255,0.05);
        z-index: 5;
        display: flex; justify-content: space-between;
    }
    
    .bot-card {
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        padding: 16px 20px;
        display: flex; align-items: center; gap: 16px;
        position: relative;
        transition: all 0.2s;
    }
    .bot-card:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .bot-avatar {
        width: 44px; height: 44px; border-radius: 10px;
        background: rgba(0,0,0,0.3); object-fit: contain;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .bot-info { flex: 1; }
    .bot-name { font-weight: 700; font-size: 14px; color: #fff; }
    .bot-meta { font-size: 11px; color: #94a3b8; margin-top: 2px; display:flex; gap:8px; align-items:center;}
    .bot-tag { background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:10px; }
    
    .btn-delete {
        background: transparent; border: none; color: #ef4444;
        cursor: pointer; opacity: 0.4; padding: 8px;
        font-size: 18px; transition: opacity 0.2s;
    }
    .btn-delete:hover { opacity: 1; }

    /* Center: Fabrication Zone */
    .panel-center {
        flex: 1;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: 40px;
        position: relative;
    }
    
    .empty-state {
        text-align: center; opacity: 0.3;
        font-size: 14px; line-height: 1.6;
        max-width: 300px;
    }
    
    /* Modal / Form */
    .fabricator-form {
        width: 100%; max-width: 420px;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 32px;
        backdrop-filter: blur(16px);
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        display: none;
        animation: slideUp 0.3s ease-out;
    }
    .fabricator-form.active { display: block; }
    
    .form-title {
        font-size: 20px; font-weight: 800; text-transform: uppercase; 
        color: #fff; margin-bottom: 24px; text-align: center;
        letter-spacing: 2px;
    }
    
    .field-group { margin-bottom: 20px; }
    .label { font-size: 11px; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin-bottom: 8px; display: block; }
    .input {
        width: 100%; background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 12px; border-radius: 8px; color: #fff; font-family: inherit; font-size: 14px;
        outline: none; transition: border-color 0.2s;
    }
    .input:focus { border-color: #6366f1; }
    
    .btn-create {
        width: 100%; padding: 14px; background: #6366f1; color: #fff;
        border: none; border-radius: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
        cursor: pointer; margin-top: 10px;
        transition: all 0.2s;
    }
    .btn-create:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(99, 102, 241, 0.4); }
    
    .btn-secondary {
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        color: #e2e8f0; cursor: pointer; border-radius: 6px;
        transition: all 0.2s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    
    .source-path {
        font-size: 10px; color: #64748b; word-break: break-all;
        margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-grid"></div>

  <div class="header">
      <h1>Bot Factory</h1>
      <div style="display:flex; gap:10px;">
          <button class="btn-create" style="width:auto; padding: 8px 16px; font-size: 11px;" onclick="refreshScan()">Rescan Folder</button>
      </div>
  </div>

  <div class="factory-layout">
      <!-- RAW ENGINES -->
      <div class="panel-left">
          <div class="panel-header">
              <span>Engine Repository</span>
              <span id="file-count" style="opacity:0.5">0</span>
          </div>
          <div class="file-list" id="fileList">
              <div style="padding:20px; text-align:center; opacity:0.5; font-size:12px;">Scanning 'engines/' folder...</div>
          </div>
      </div>

      <!-- FABRICATOR CENTER -->
      <div class="panel-center">
          <div id="emptyState" class="empty-state">
              <div style="font-size:48px; margin-bottom:16px;">‚öôÔ∏è</div>
              Select a raw engine binary from the left repository to configure a new Bot.
          </div>

          <div id="fabricatorForm" class="fabricator-form">
              <div class="form-title">Construct Bot</div>
              
              <div class="source-path" id="selectedPath">...</div>
              
              <div class="field-group">
                  <label class="label">Bot Codename</label>
                  <input type="text" id="botName" class="input" placeholder="e.g. Stockfish Aggressive">
              </div>
              
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                  <div class="field-group">
                      <label class="label">ELO Limit</label>
                      <input type="number" id="botElo" class="input" value="1500">
                  </div>
                  <div class="field-group">
                      <label class="label">Threads</label>
                      <input type="number" id="botThreads" class="input" value="1">
                  </div>
              </div>
              
              <div class="field-group">
                  <label class="label">Visual Identity</label>
                  <div style="display:flex; gap:16px; align-items:flex-start;">
                      <img id="avatarPreview" src="../assets/pieces/bK.png" style="width:64px; height:64px; border-radius:12px; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); object-fit:contain; padding:4px;">
                      <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                          <select id="botAvatarSelect" class="input" style="padding:8px; font-size:12px;" onchange="updateAvatarFromSelect()">
                              <option value="bK.png" selected>Standard: Black King</option>
                              <option value="bQ.png">Standard: Black Queen</option>
                              <option value="bN.png">Standard: Black Knight</option>
                              <option value="bR.png">Standard: Black Rook</option>
                              <option value="wK.png">Standard: White King</option>
                              <option value="wQ.png">Standard: White Queen</option>
                              <option value="wN.png">Standard: White Knight</option>
                          </select>
                          <button class="btn-secondary" style="padding:8px; font-size:11px; width:100%;" onclick="uploadAvatar()">üìÇ Browse Custom Image...</button>
                      </div>
                  </div>
              </div>
              
              <button class="btn-create" onclick="createBot()">Activate Bot</button>
              <button onclick="cancelCreate()" style="width:100%; background:transparent; border:none; color:#64748b; font-size:12px; cursor:pointer; margin-top:12px;">Cancel</button>
          </div>
      </div>

      <!-- ACTIVE BOTS -->
      <div class="panel-right">
          <div class="panel-header">
              <span>Active Roster</span>
              <span id="bot-count" style="opacity:0.5">0</span>
          </div>
          <div class="bot-list" id="botList">
              <!-- Bots Injected Here -->
          </div>
      </div>
  </div>

  <script>
      let rawFiles = [];
      let activeBots = [];
      let currentFilePath = null;
      let currentAvatarPath = "bK.png"; // Stores either filename (for presets) or absolute path (for custom)

      async function init() {
          await refreshScan();
          await refreshBots();
          
          // Apply Theme
          const prefs = await window.electronAPI.getPreferences();
          if(prefs?.boardTheme) document.documentElement.setAttribute('data-theme', prefs.boardTheme);
      }

      async function refreshScan() {
          const listEl = document.getElementById('fileList');
          listEl.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5; font-size:12px;">Scanning...</div>';
          
          try {
              rawFiles = await window.electronAPI.invoke('scan-engines-dir') || []; 
              document.getElementById('file-count').textContent = rawFiles.length;
              
              listEl.innerHTML = '';
              if (rawFiles.length === 0) {
                  listEl.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5; font-size:12px;">No executables found in /engines folder.</div>';
                  return;
              }
              
              rawFiles.forEach(pathStr => {
                  const fileName = pathStr.split(/[/\\]/).pop();
                  const div = document.createElement('div');
                  div.className = 'file-item';
                  div.innerHTML = `<span class="file-icon">üìÑ</span> <span class="file-name">${fileName}</span>`;
                  div.onclick = () => openFabricator(pathStr, fileName);
                  listEl.appendChild(div);
              });
          } catch(e) {
              console.error(e);
              listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#f87171; font-size:12px;">Scan Failed</div>';
          }
      }

      async function refreshBots() {
          const listEl = document.getElementById('botList');
          activeBots = await window.electronAPI.enginesGetAll() || [];
          document.getElementById('bot-count').textContent = activeBots.length;
          listEl.innerHTML = '';
          
          if (activeBots.length === 0) {
              listEl.innerHTML = '<div style="padding:30px; text-align:center; opacity:0.4; font-size:12px;">No active bots deployed.</div>';
              return;
          }

          // Define Groups
          const groups = {
              'Grandmaster (2400+)': [],
              'Master (2000-2399)': [],
              'Advanced (1600-1999)': [],
              'Intermediate (1200-1599)': [],
              'Beginner (< 1200)': [],
              'AI Personas': []
          };

          // Sort into buckets
          activeBots.forEach(bot => {
              if (bot.type === 'llm') {
                  groups['AI Personas'].push(bot);
              } else {
                  const elo = bot.elo || 1500;
                  if (elo >= 2400) groups['Grandmaster (2400+)'].push(bot);
                  else if (elo >= 2000) groups['Master (2000-2399)'].push(bot);
                  else if (elo >= 1600) groups['Advanced (1600-1999)'].push(bot);
                  else if (elo >= 1200) groups['Intermediate (1200-1599)'].push(bot);
                  else groups['Beginner (< 1200)'].push(bot);
              }
          });

          // Render buckets
          for (const [groupName, bots] of Object.entries(groups)) {
              if (bots.length === 0) continue;
              
              // Sort by name within group
              bots.sort((a, b) => a.name.localeCompare(b.name));

              // Header
              const header = document.createElement('div');
              header.className = 'group-header';
              header.innerHTML = `<span>${groupName}</span> <span style="opacity:0.5">${bots.length}</span>`;
              listEl.appendChild(header);

              // Bots
              bots.forEach(bot => {
                  const div = document.createElement('div');
                  div.className = 'bot-card';
                  
                  let avatarSrc = bot.avatar || '../assets/pieces/bK.png';
                  if (!avatarSrc.includes('/') && !avatarSrc.includes('\\')) avatarSrc = `../assets/pieces/${avatarSrc}`;
                  
                  div.innerHTML = `
                      <img src="${avatarSrc}" class="bot-avatar" onerror="this.src='../assets/icon/chessly.png'">
                      <div class="bot-info">
                          <div class="bot-name">${bot.name}</div>
                          <div class="bot-meta">
                              <span class="bot-tag">${bot.type === 'llm' ? bot.model : (bot.elo + ' ELO')}</span>
                              ${bot.type === 'uci' ? '<span class="bot-tag">Stockfish</span>' : ''}
                          </div>
                      </div>
                      <button class="btn-delete" onclick="deleteBot('${bot.id}')" title="Decommission">√ó</button>
                  `;
                  listEl.appendChild(div);
              });
          }
      }

      function openFabricator(pathStr, fileName) {
          currentFilePath = pathStr;
          document.getElementById('emptyState').style.display = 'none';
          document.getElementById('fabricatorForm').classList.add('active');
          document.getElementById('selectedPath').textContent = pathStr;
          
          // Reset avatar state
          currentAvatarPath = "bK.png";
          document.getElementById('botAvatarSelect').value = "bK.png";
          document.getElementById('avatarPreview').src = "../assets/pieces/bK.png";
          
          // Auto-fill name
          const base = fileName.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " ");
          document.getElementById('botName').value = base.charAt(0).toUpperCase() + base.slice(1);
      }
      
      function updateAvatarFromSelect() {
          const val = document.getElementById('botAvatarSelect').value;
          currentAvatarPath = val;
          document.getElementById('avatarPreview').src = `../assets/pieces/${val}`;
      }
      
      async function uploadAvatar() {
          const path = await window.electronAPI.browseImageFile();
          if (path) {
              currentAvatarPath = path; // Absolute path
              document.getElementById('avatarPreview').src = path;
              // Reset select to indicate custom (optional visual cue)
          }
      }

      function cancelCreate() {
          document.getElementById('fabricatorForm').classList.remove('active');
          document.getElementById('emptyState').style.display = 'block';
          currentFilePath = null;
      }

      async function createBot() {
          if (!currentFilePath) return;
          
          const bot = {
              id: 'bot-' + Date.now(),
              name: document.getElementById('botName').value || "Unnamed Bot",
              type: 'uci', 
              path: currentFilePath,
              elo: parseInt(document.getElementById('botElo').value) || 1500,
              threads: parseInt(document.getElementById('botThreads').value) || 1,
              avatar: currentAvatarPath, // Uses currently held path/filename
              uciLimitStrength: true 
          };
          
          await window.electronAPI.enginesSave(bot);
          cancelCreate();
          refreshBots();
      }

      async function deleteBot(id) {
          if(confirm("Decommission this bot unit?")) {
              await window.electronAPI.enginesDelete(id);
              refreshBots();
          }
      }

      init();
  </script>
</body>
</html>
