
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Engines Command</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
      body { 
          padding: 0; margin: 0; 
          display: flex; height: 100vh; 
          background: var(--app-bg); 
          overflow: hidden; 
          font-family: 'Inter', sans-serif;
      }
      
      /* Animated Background Grid */
      .bg-tech {
          position: absolute; inset: 0; z-index: 0;
          background-image: 
              linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
          background-size: 40px 40px;
          animation: panGrid 20s linear infinite;
          opacity: 0.5;
      }
      @keyframes panGrid { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }

      /* Layout */
      .layout {
          position: relative; z-index: 10;
          display: flex; width: 100%; height: 100%;
          padding: 20px; gap: 20px;
      }

      /* Left: Engine List (Sidebar) */
      .list-panel {
          width: 300px; flex-shrink: 0;
          background: rgba(20, 20, 25, 0.8);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 16px;
          display: flex; flex-direction: column;
          overflow: hidden;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }

      .list-header {
          padding: 20px;
          border-bottom: 1px solid rgba(255,255,255,0.05);
          display: flex; justify-content: space-between; align-items: center;
      }
      .list-header h2 { margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }

      .engine-scroll {
          flex: 1; overflow-y: auto; padding: 12px;
          display: flex; flex-direction: column; gap: 8px;
      }

      /* Engine Cards */
      .eng-card-item {
          display: flex; align-items: center; gap: 12px;
          padding: 12px; border-radius: 12px;
          background: rgba(255,255,255,0.03);
          border: 1px solid rgba(255,255,255,0.05);
          cursor: pointer; transition: all 0.2s;
      }
      .eng-card-item:hover {
          background: rgba(255,255,255,0.08);
          transform: translateX(4px);
      }
      .eng-card-item.selected {
          background: rgba(99, 102, 241, 0.15);
          border-color: var(--primary-accent);
          box-shadow: 0 0 15px var(--primary-glow);
      }
      
      .eng-avatar-mini {
          width: 40px; height: 40px; border-radius: 8px;
          background: rgba(0,0,0,0.3); object-fit: contain; padding: 4px;
      }
      .eng-details { flex: 1; min-width: 0; }
      .eng-name { font-weight: 700; font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .eng-sub { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }
      
      .add-btn {
          width: 100%; padding: 12px;
          background: var(--primary-accent); color: #fff;
          border: none; font-weight: 700; cursor: pointer;
          transition: all 0.2s;
      }
      .add-btn:hover { filter: brightness(1.1); }

      /* Right: Editor (Main) */
      .editor-panel {
          flex: 1;
          background: rgba(255,255,255,0.02);
          border: 1px solid rgba(255,255,255,0.08);
          border-radius: 16px;
          backdrop-filter: blur(10px);
          display: none; flex-direction: column;
          overflow: hidden;
          animation: fadeIn 0.3s ease;
      }
      .editor-panel.active { display: flex; }
      
      .editor-scroll {
          flex: 1; overflow-y: auto; padding: 30px;
      }
      
      /* Form Elements */
      .field-group { margin-bottom: 20px; }
      .field-label { 
          display: block; font-size: 11px; text-transform: uppercase; 
          font-weight: 700; color: var(--primary-accent); margin-bottom: 8px; letter-spacing: 0.5px;
      }
      
      .hero-input {
          width: 100%; background: transparent;
          border: none; border-bottom: 2px solid rgba(255,255,255,0.1);
          font-size: 24px; font-weight: 800; color: #fff;
          padding: 10px 0; outline: none; transition: border-color 0.2s;
      }
      .hero-input:focus { border-color: var(--primary-accent); }
      
      .std-input, .std-select, .std-textarea {
          width: 100%; background: rgba(0,0,0,0.3);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 8px; padding: 12px;
          color: #fff; font-family: inherit; font-size: 13px;
          outline: none; transition: all 0.2s;
      }
      .std-input:focus, .std-select:focus, .std-textarea:focus {
          border-color: var(--primary-accent); background: rgba(0,0,0,0.5);
      }
      
      /* Type Tabs */
      .type-switch {
          display: flex; gap: 4px; background: rgba(0,0,0,0.3);
          padding: 4px; border-radius: 10px; width: fit-content; margin-bottom: 24px;
      }
      .type-opt {
          padding: 8px 24px; border-radius: 8px; cursor: pointer;
          font-size: 12px; font-weight: 700; color: var(--text-muted);
          transition: all 0.2s;
      }
      .type-opt.active { background: var(--primary-accent); color: #fff; box-shadow: 0 4px 10px var(--primary-glow); }

      /* Footer */
      .editor-footer {
          padding: 20px; border-top: 1px solid rgba(255,255,255,0.05);
          display: flex; justify-content: space-between; align-items: center;
          background: rgba(0,0,0,0.2);
      }
      
      .empty-state {
          flex: 1; display: flex; align-items: center; justify-content: center;
          flex-direction: column; color: var(--text-muted); opacity: 0.5;
      }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-tech"></div>

  <div class="layout">
      
      <!-- Sidebar -->
      <div class="list-panel">
          <div class="list-header">
              <h2>Agents</h2>
              <div style="font-size:10px; opacity:0.5;">Active & Ready</div>
          </div>
          <div class="engine-scroll" id="enginesGrid">
              <!-- List Items -->
          </div>
          <button class="add-btn" id="addEngineBtn">+ DEPLOY NEW AGENT</button>
      </div>

      <!-- Main Editor -->
      <div class="editor-panel" id="editorPanel">
          <div class="editor-scroll">
              <div style="display:flex; gap:20px; align-items:flex-start; margin-bottom:30px;">
                  <div style="position:relative;">
                      <img id="engineAvatarInput" src="../assets/pieces/bN.png" style="width:80px; height:80px; border-radius:16px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); object-fit:contain; padding:8px;">
                      <button id="browseAvatarBtn" class="btn-secondary" style="position:absolute; bottom:-10px; right:-10px; width:30px; height:30px; padding:0; border-radius:50%; background:#333; border:1px solid #555;">✎</button>
                  </div>
                  <div style="flex:1;">
                      <label class="field-label">CODENAME</label>
                      <input type="text" id="engineNameInput" class="hero-input" placeholder="Agent Name">
                  </div>
              </div>

              <div class="type-switch">
                  <div class="type-opt active" id="tabUCI">UCI ENGINE</div>
                  <div class="type-opt" id="tabLLM">AI PERSONA</div>
              </div>

              <!-- UCI Fields -->
              <div id="sectionUCI">
                  <div class="field-group">
                      <label class="field-label">EXECUTABLE PATH</label>
                      <div style="display:flex; gap:8px;">
                          <input type="text" id="enginePathInput" class="std-input" readonly placeholder="Select binary...">
                          <button id="browseEngineBtn" class="btn-secondary" style="width:auto;">Browse</button>
                      </div>
                  </div>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                      <div class="field-group">
                          <label class="field-label">ELO LIMIT</label>
                          <input type="number" id="engineEloInput" class="std-input" placeholder="1500">
                      </div>
                      <div class="field-group">
                          <label class="field-label">THREADS</label>
                          <input type="number" id="engineThreads" class="std-input" value="1">
                      </div>
                  </div>
                  <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                      <input type="checkbox" id="uciLimitStrength">
                      <label for="uciLimitStrength" style="font-size:12px; color:var(--text-muted);">Limit Strength (Human-like)</label>
                  </div>
              </div>

              <!-- LLM Fields -->
              <div id="sectionLLM" class="hidden">
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                      <div class="field-group">
                          <label class="field-label">PROVIDER</label>
                          <select id="llmProvider" class="std-select">
                              <option value="gemini">Google Gemini</option>
                              <option value="groq">Groq</option>
                              <option value="openrouter">OpenRouter</option>
                              <option value="openai">OpenAI</option>
                          </select>
                      </div>
                      <div class="field-group">
                          <label class="field-label" id="lblApiKey">API KEY</label>
                          <div style="display:flex; gap:8px;">
                              <input type="password" id="llmApiKey" class="std-input" placeholder="Secret Key">
                              <button id="verifyKeyBtn" class="btn-secondary" style="width:auto; font-size:11px;">Test</button>
                          </div>
                      </div>
                  </div>
                  
                  <div class="field-group" id="modelSection">
                      <label class="field-label">MODEL ID</label>
                      <select id="llmModelSelect" class="std-select">
                          <!-- Populated by Verify or Default -->
                          <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                          <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                      </select>
                  </div>

                  <div class="field-group">
                      <label class="field-label">SYSTEM INSTRUCTION</label>
                      <textarea id="llmPrompt" class="std-textarea" rows="3" placeholder="Define the AI's personality and playstyle..."></textarea>
                  </div>
                  
                  <div class="field-group">
                      <label class="field-label">CREATIVITY (TEMP): <span id="tempVal">0.5</span></label>
                      <input type="range" id="llmTemp" style="width:100%;" min="0" max="2" step="0.1" value="0.5">
                  </div>
              </div>

          </div>
          
          <div class="editor-footer">
              <button id="deleteEngineBtn" class="btn-danger">Decommission</button>
              <div style="display:flex; gap:12px;">
                  <button id="cancelEditBtn" class="btn-secondary">Cancel</button>
                  <button id="saveEngineBtn" class="btn-primary">SAVE CONFIG</button>
              </div>
          </div>
      </div>
      
      <div class="empty-state" id="emptyState">
          <div style="font-size:48px; margin-bottom:10px;">♟</div>
          <div>Select an agent to configure</div>
      </div>

  </div>

  <script>
    const addEngineBtn = document.getElementById("addEngineBtn");
    const deleteEngineBtn = document.getElementById("deleteEngineBtn");
    const enginesGrid = document.getElementById("enginesGrid");
    const editorPanel = document.getElementById("editorPanel");
    const emptyState = document.getElementById("emptyState");
    
    const tabUCI = document.getElementById("tabUCI");
    const tabLLM = document.getElementById("tabLLM");
    const sectionUCI = document.getElementById("sectionUCI");
    const sectionLLM = document.getElementById("sectionLLM");
    
    // Inputs
    const engineNameInput = document.getElementById("engineNameInput");
    const engineAvatarInput = document.getElementById("engineAvatarInput");
    const browseAvatarBtn = document.getElementById("browseAvatarBtn");
    const saveEngineBtn = document.getElementById("saveEngineBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    
    // UCI
    const enginePathInput = document.getElementById("enginePathInput");
    const browseEngineBtn = document.getElementById("browseEngineBtn");
    const engineEloInput = document.getElementById("engineEloInput");
    const engineThreads = document.getElementById("engineThreads");
    const uciLimitStrength = document.getElementById("uciLimitStrength");
    
    // LLM
    const llmProvider = document.getElementById("llmProvider");
    const llmApiKey = document.getElementById("llmApiKey");
    const verifyKeyBtn = document.getElementById("verifyKeyBtn");
    const llmModelSelect = document.getElementById("llmModelSelect");
    const llmPrompt = document.getElementById("llmPrompt");
    const llmTemp = document.getElementById("llmTemp");
    const tempVal = document.getElementById("tempVal");
    const modelSection = document.getElementById("modelSection");
    const lblApiKey = document.getElementById("lblApiKey");

    let engines = [];
    let selectedEngineId = null;
    let editingEngine = null;
    let currentType = 'uci';
    let currentAvatarPath = "";

    // --- Logic ---
    
    function setType(type) {
        currentType = type;
        if(type === 'uci') {
            tabUCI.classList.add('active'); tabLLM.classList.remove('active');
            sectionUCI.classList.remove('hidden'); sectionLLM.classList.add('hidden');
        } else {
            tabUCI.classList.remove('active'); tabLLM.classList.add('active');
            sectionUCI.classList.add('hidden'); sectionLLM.classList.remove('hidden');
        }
    }
    tabUCI.onclick = () => setType('uci');
    tabLLM.onclick = () => setType('llm');
    
    llmTemp.oninput = () => tempVal.textContent = llmTemp.value;
    
    function resolveAvatarSrc(pathStr) {
        if (!pathStr) return "../assets/icon/chessly.png";
        if (pathStr.includes('/') || pathStr.includes('\\')) return pathStr; // Absolute or already full path
        return `../assets/pieces/${pathStr}`; // Fallback to pieces
    }

    async function loadEngines() {
      try {
        if (!window.electronAPI) return;
        const list = window.electronAPI.enginesGetAll
          ? await window.electronAPI.enginesGetAll()
          : await window.electronAPI.invoke?.("engines-get-all");
        engines = list || [];
        renderList();
      } catch (e) {
        alert("Failed to load engines: " + e);
      }
    }

    function renderList() {
        enginesGrid.innerHTML = "";
        engines.forEach(e => {
            const div = document.createElement("div");
            div.className = "eng-card-item" + (e.id === selectedEngineId ? " selected" : "");
            
            const avatarSrc = resolveAvatarSrc(e.avatar);
            
            div.innerHTML = `
                <img class="eng-avatar-mini" src="${avatarSrc}" onerror="this.src='../assets/icon/chessly.png'">
                <div class="eng-details">
                    <div class="eng-name">${e.name}</div>
                    <div class="eng-sub">${e.type === 'llm' ? e.provider : 'Stockfish'}</div>
                </div>
            `;
            div.onclick = () => {
                selectedEngineId = e.id;
                editingEngine = { ...e };
                renderList();
                openEditor(editingEngine);
            };
            enginesGrid.appendChild(div);
        });
    }

    function openEditor(engine) {
        editorPanel.classList.add('active');
        emptyState.style.display = 'none';
        
        engineNameInput.value = engine.name || "";
        currentAvatarPath = engine.avatar || "";
        
        const avSrc = resolveAvatarSrc(currentAvatarPath);
        engineAvatarInput.src = avSrc;
        
        setType(engine.type || 'uci');
        
        if(engine.type === 'uci') {
            enginePathInput.value = engine.path || "";
            engineThreads.value = engine.threads || 1;
            engineEloInput.value = engine.elo || 1500;
            uciLimitStrength.checked = !!engine.uciLimitStrength;
        } else {
            const prov = engine.provider === "google" ? "gemini" : engine.provider;
            llmProvider.value = prov || "gemini";
            llmApiKey.value = engine.apiKey || "";
            llmPrompt.value = engine.systemInstruction || "";
            llmTemp.value = engine.temperature || 0.5;
            tempVal.textContent = llmTemp.value;
            
            if(engine.model) {
                // Try to select existing, or add it if missing from defaults
                if (!Array.from(llmModelSelect.options).some(o => o.value === engine.model)) {
                    const opt = document.createElement("option");
                    opt.value = engine.model; opt.innerText = engine.model;
                    llmModelSelect.appendChild(opt);
                }
                llmModelSelect.value = engine.model;
            }
        }
    }
    
    function closeEditor() {
        editorPanel.classList.remove('active');
        emptyState.style.display = 'flex';
        selectedEngineId = null;
        renderList();
    }

    addEngineBtn.onclick = () => {
        editingEngine = { id: null, name: "New Agent", type: 'uci', elo: 1500, threads: 1 };
        selectedEngineId = null;
        openEditor(editingEngine);
    };
    
    cancelEditBtn.onclick = closeEditor;
    
    browseEngineBtn.onclick = async () => {
        const path = await window.electronAPI?.browseEngineFile();
        if(path) enginePathInput.value = path;
    };
    
    browseAvatarBtn.onclick = async () => {
        const path = await window.electronAPI?.browseImageFile();
        if(path) { 
            currentAvatarPath = path; 
            engineAvatarInput.src = path; // Absolute path from file system
        }
    };
    
    verifyKeyBtn.onclick = async () => {
        verifyKeyBtn.textContent = "Checking...";
        try {
            const res = await window.electronAPI.aiVerifyAndListModels({ apiKey: llmApiKey.value, provider: llmProvider.value });
            if(res.success && res.models && res.models.length > 0) {
                llmModelSelect.innerHTML = "";
                res.models.forEach(m => {
                    const opt = document.createElement("option"); 
                    opt.value = m; opt.innerText = m;
                    llmModelSelect.appendChild(opt);
                });
                verifyKeyBtn.textContent = "Verified";
                verifyKeyBtn.style.color = "#4ade80";
            } else { 
                alert("Verification failed. Check API Key."); 
                verifyKeyBtn.textContent = "Retry";
                verifyKeyBtn.style.color = "";
            }
        } catch (e) {
            alert("Error: " + e);
            verifyKeyBtn.textContent = "Retry";
        }
    };
    
    saveEngineBtn.onclick = async () => {
        if(!editingEngine) return;
        if (!window.electronAPI) { alert("Engine API not available."); return; }

        editingEngine.name = engineNameInput.value.trim() || "Agent";
        editingEngine.type = currentType;
        editingEngine.avatar = currentAvatarPath; // Saves absolute path or filename
        
        if(currentType === 'uci') {
            editingEngine.path = enginePathInput.value;
            editingEngine.threads = parseInt(engineThreads.value) || 1;
            editingEngine.elo = parseInt(engineEloInput.value) || 1500;
            editingEngine.uciLimitStrength = uciLimitStrength.checked;
        } else {
            editingEngine.provider = llmProvider.value;
            editingEngine.apiKey = llmApiKey.value;
            editingEngine.model = llmModelSelect.value;
            editingEngine.systemInstruction = llmPrompt.value;
            editingEngine.temperature = parseFloat(llmTemp.value);
        }

        try {
            engines = window.electronAPI.enginesSave
              ? await window.electronAPI.enginesSave(editingEngine)
              : await window.electronAPI.invoke?.("engines-save", editingEngine);
            closeEditor();
            loadEngines();
        } catch (e) {
            alert("Save failed: " + e);
        }
    };
    
    deleteEngineBtn.onclick = async () => {
        if(selectedEngineId && confirm("Retire this agent?")) {
            engines = await window.electronAPI?.enginesDelete(selectedEngineId);
            closeEditor(); loadEngines();
        }
    };

    loadEngines();
  </script>
</body>
</html>
